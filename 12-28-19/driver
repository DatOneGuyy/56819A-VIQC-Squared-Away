#pragma config(Sensor, port1,  color1,         sensorVexIQ_LED)
#pragma config(Sensor, port2,  gyro,           sensorVexIQ_Gyro)
#pragma config(Sensor, port3,  color2,         sensorVexIQ_LED)
#pragma config(Sensor, port4,  color3,         sensorVexIQ_LED)
#pragma config(Sensor, port6,  color5,         sensorVexIQ_LED)
#pragma config(Sensor, port8,  color4,         sensorVexIQ_LED)
#pragma config(Motor,  motor5,          dropper,       tmotorVexIQ, PIDControl, encoder)
#pragma config(Motor,  motor7,          frontarm,      tmotorVexIQ, PIDControl, reversed, encoder)
#pragma config(Motor,  motor9,          spintake,      tmotorVexIQ, PIDControl, encoder)
#pragma config(Motor,  motor10,         leftdrive,     tmotorVexIQ, PIDControl, reversed, driveLeft, encoder)
#pragma config(Motor,  motor11,         rightdrive,    tmotorVexIQ, PIDControl, driveRight, encoder)
#pragma config(Motor,  motor12,         backarm,       tmotorVexIQ, PIDControl, encoder)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

int t = 0;
int interval = 1500;
int cycles = 6;
int cyclePeriod = interval * cycles;

int leftspeed;
int rightspeed;

bool backarmup = false;

bool previousFramePressed = false;
bool previousFramePressedEUp = false;
bool previousFramePressedEDown = false;

int spintakeState = 0;

int temp;

int sign(int input) {
	return input == 0 ? 0 : abs(input) / input;
}

void color(TSimpleColors c) {
	setTouchLEDColor(color1, c);
	setTouchLEDColor(color2, c);
	setTouchLEDColor(color3, c);
	setTouchLEDColor(color4, c);
	setTouchLEDColor(color5, c);
}

void setup() {
	setMotorSpeed(dropper, 0);
	setMotorSpeed(frontarm, 0);
	setMotorSpeed(spintake, 0);
	setMotorSpeed(leftdrive, 0); //222 -147
	setMotorSpeed(rightdrive, 0);
	setMotorSpeed(backarm, 0);
	resetMotorEncoder(dropper);
	resetMotorEncoder(frontarm);
	resetMotorEncoder(spintake);
	resetMotorEncoder(leftdrive);
	resetMotorEncoder(rightdrive);
	resetMotorEncoder(backarm);
	resetGyro(gyro);
}

bool gear = true;

task drop() {
	while (true) {
		if (getJoystickValue(BtnFUp) == 1) {
			setMotorSpeed(dropper, -100);
			sleep(300);
			setMotorSpeed(dropper, 100);
			sleep(300);
			setMotorSpeed(dropper, 10);
		}
	}
}

task unstuck() {
	while (true) {
  	if (getJoystickValue(BtnFDown) == 1) {
  		setMotorSpeed(backarm, 100);
  		sleep(300);
  		setMotorSpeed(backarm, -100);
  		sleep(300);
  		setMotorSpeed(backarm, 0);
  	}
	}
}

task main() {
	setup();
	startTask(drop);
	startTask(unstuck);
	while (true) {
		t++;

		if (t % cyclePeriod < interval) {
			color(colorRed);
		} else if (t % cyclePeriod < interval * 2) {
			color(colorOrange);
		} else if (t % cyclePeriod < interval * 3) {
			color(colorYellow);
		} else if (t % cyclePeriod < interval * 4) {
			color(colorGreen);
		} else if (t % cyclePeriod < interval * 5) {
			color(colorBlue);
		} else if (t % cyclePeriod < interval * 6) {
			color(colorViolet);
		}

		if (getJoystickValue(BtnLUp) == 1 && getJoystickValue(BtnLDown) == 0) {
			setMotorSpeed(frontarm, 100);
			setMotorSpeed(spintake, 0);
		} else if (getJoystickValue(BtnLDown) == 1 && getJoystickValue(BtnLUp) == 0) {
			setMotorSpeed(frontarm, -100);
			setMotorSpeed(spintake, 0);
		} else {
			setMotorSpeed(frontarm, 0);
		}

		if (getJoystickValue(BtnRUp) == 1 && getJoystickValue(BtnRDown) == 0 && getMotorEncoder(backarm) < 60) {
			setMotorSpeed(backarm, 100);
		} else if (getJoystickValue(BtnRDown) == 1 && getJoystickValue(BtnRUp) == 0 && getMotorEncoder(backarm) > 0) {
			setMotorSpeed(backarm, -100);
		} else {
			setMotorSpeed(backarm, 0);
		}

		if (getJoystickValue(BtnEDown) == 0 && previousFramePressedEDown) {
			previousFramePressedEDown = false;
		} else if (getJoystickValue(BtnEDown) == 1 && !previousFramePressedEDown) {
			spintakeState--;
			previousFramePressedEDown = true;
		}

		if (getJoystickValue(BtnEUp) == 0 && previousFramePressedEUp) {
			previousFramePressedEUp = false;
		} else if (getJoystickValue(BtnEUp) == 1 && !previousFramePressedEUp) {
			spintakeState++;
			previousFramePressedEUp = true;
		}

		if (getJoystickValue(BtnLUp) == 1 || getJoystickValue(BtnLDown) == 1) {
			spintakeState = 20000;
		}

		if (spintakeState == 20000) {
			spintakeState = 0;
		} else if (spintakeState < -1) {
			spintakeState = -1;
		} else if (spintakeState > 1) {
			spintakeState = 1;
		}

		if (getJoystickValue(BtnFDown) == 0 && previousFramePressed) {
			previousFramePressed = false;
		} else if (getJoystickValue(BtnFDown) == 1 && !previousFramePressed) {
			gear = !gear;
			previousFramePressed = true;
		}


		leftspeed = getJoystickValue(ChA) * getJoystickValue(ChA) * getJoystickValue(ChA) / 10000 * (gear ? 1 : 0.6) * (abs(getJoystickValue(ChA)) > 10 ? 1 : 0);
		rightspeed = getJoystickValue(ChD) * getJoystickValue(ChD) * getJoystickValue(ChD) / 10000 * (gear ? 1 : 0.6) * (abs(getJoystickValue(ChD)) > 10 ? 1 : 0);

		if (((sign(leftspeed) == sign(rightspeed)) || (sign(leftspeed) == 0) || (sign(rightspeed) == 0))&& abs(leftspeed - rightspeed) < (getJoystickValue(BtnLUp) == 1 ? 50 : 30)) {
			temp = leftspeed * 0.5 + rightspeed * 0.5;
			leftspeed = temp;
			rightspeed = temp;
		}

		setMotorSpeed(spintake, spintakeState * 100);
		setMotorSpeed(leftdrive, leftspeed);
		setMotorSpeed(rightdrive, rightspeed);
	}
}
